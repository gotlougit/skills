#!/usr/bin/env bash

# Drives ephemeral Docker containers for development
# Generated by docker-dev-environment skill

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="__PROJECT_DIR__"
IMAGE_NAME="__IMAGE_NAME__"
CONTAINER_HOSTNAME="__CONTAINER_HOSTNAME__"

ARG0="$0"
print_help() {
    NAME=$(basename "$ARG0")
    cat <<EOF
Usage: $NAME COMMAND
       Sets up ephemeral Docker containers for ${PROJECT_DIR} development

Commands:
    $NAME docker    Build/rebuild the Docker image
    $NAME build     Build the project inside the container
    $NAME run       Run the project inside the container
    $NAME test      Run tests inside the container
    $NAME sh        Open an interactive shell in the container
    $NAME help      Show this help screen
EOF
}

docker_setup() {
    local should_upgrade="$1"

    if ! command -v docker &>/dev/null; then
        echo "ERROR: docker command not found. Please install Docker."
        exit 1
    fi

    if [ ! -f "${SCRIPT_DIR}/Dockerfile" ]; then
        echo "ERROR: Dockerfile not found in ${SCRIPT_DIR}"
        exit 1
    fi

    local image_exists
    image_exists=$(docker images -q "${IMAGE_NAME}")

    if [ -z "$image_exists" ] || [ "$should_upgrade" = "true" ]; then
        echo "Building ${IMAGE_NAME} image..."
        docker build -f "${SCRIPT_DIR}/Dockerfile" "${SCRIPT_DIR}" -t "${IMAGE_NAME}"
    fi
}

ensure_cache_dirs() {
    # __CACHE_DIRS_PLACEHOLDER__
    # Example:
    # mkdir -p "${SCRIPT_DIR}/.cache/cargo/registry"
    # mkdir -p "${SCRIPT_DIR}/.cache/cargo/git"
    :
}

CMD="${1:-help}"

# __BUILD_CMD_PLACEHOLDER__
BUILD_CMD="echo 'TODO: set build command'"
# __TEST_CMD_PLACEHOLDER__
TEST_CMD="echo 'TODO: set test command'"
# __RUN_CMD_PLACEHOLDER__
RUN_CMD="echo 'TODO: set run command'"

# __ENV_SETUP_PLACEHOLDER__
# Commands to run before the main command inside the container
# eg: '. "$HOME/.cargo/env"' for Rust
ENV_SETUP=""

if [ "$CMD" = "docker" ]; then
    docker_setup "true"
    exit 0
elif [ "$CMD" = "build" ]; then
    CONTAINER_CMD="${BUILD_CMD}"
elif [ "$CMD" = "test" ]; then
    CONTAINER_CMD="${TEST_CMD}"
elif [ "$CMD" = "run" ]; then
    CONTAINER_CMD="${RUN_CMD}"
elif [ "$CMD" = "sh" ]; then
    CONTAINER_CMD="bash"
elif [ "$CMD" = "help" ] || [ "$CMD" = "--help" ] || [ "$CMD" = "-h" ]; then
    print_help
    exit 0
else
    echo "Unknown command: $CMD"
    print_help
    exit 1
fi

docker_setup "false"
ensure_cache_dirs

if [ ! -d "${SCRIPT_DIR}/${PROJECT_DIR}" ]; then
    echo "ERROR: Project directory '${PROJECT_DIR}' not found in ${SCRIPT_DIR}"
    exit 1
fi

if [ "${ALLOW_ROOTFUL_DOCKER:-}" != "true" ]; then
    is_rootless=$(docker info -f "{{println .SecurityOptions}}" 2>/dev/null | grep rootless || true)
    if [ -z "$is_rootless" ]; then
        echo "WARNING: Running with rootful Docker."
        echo "This reduces isolation. To suppress, set ALLOW_ROOTFUL_DOCKER=true"
    fi
fi

DOCKER_ARGS=(
    --rm -it
    --name "${IMAGE_NAME}_container"
    --cap-add=SYS_PTRACE
    --security-opt seccomp=unconfined
    --hostname "${CONTAINER_HOSTNAME}"
    --mount "type=bind,source=${SCRIPT_DIR}/${PROJECT_DIR},target=/app"
    # __MOUNT_PLACEHOLDER__
)

# __PORT_PLACEHOLDER__
# Example: DOCKER_ARGS+=(-p 3000:3000)

FULL_CMD="${ENV_SETUP:+${ENV_SETUP} && }cd /app && ${CONTAINER_CMD}"

docker run "${DOCKER_ARGS[@]}" \
    "${IMAGE_NAME}:latest" bash -c \
    "${FULL_CMD}"
